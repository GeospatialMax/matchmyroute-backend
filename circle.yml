machine:
  node:
    version: 6
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: conf/key-file.json
    GCLOUD_PROJECT: timepix-dev
    CLOUDSDK_CORE_PROJECT: timepix-dev
    DATASTORE_PROJECT_ID: timepix-dev
    IMAGES_URL: https://storage.googleapis.com/timepix-dev/images

dependencies:
  cache_directories:
    - "/home/ubuntu/.config/gcloud"
    - "/opt/circleci/nodejs/"
  post:
    - npm run clean

test:
  post:
    - mkdir -p temp
    - tar -cvzf temp/build.tgz build
    - cp -a temp/build.tgz $CIRCLE_ARTIFACTS/

deployment:
  production:
    branch: gae
    commands:
      - sudo /opt/google-cloud-sdk/bin/gcloud components update -q
#     - sudo /opt/google-cloud-sdk/bin/gcloud components install beta -q
      - sudo chown ubuntu.ubuntu -R /home/ubuntu/.config/gcloud
      - gcloud auth activate-service-account --key-file conf/key-file.json
      - gcloud config set project timepix-dev
      - npm run deploy
      - URL=https://timepix-dev.appspot.com npm run e2etest
  heroku:
    branch: master
    commands:
      - cp conf/.netrc ~/
      - heroku git:remote -a timepix-dev
      - heroku config:set GOOGLE_APPLICATION_CREDENTIALS="conf/key-file.json"
      - heroku config:set IMAGES_URL="https://storage.googleapis.com/timepix-dev/images"
      - heroku config:set PROCESS_TYPE="web"
      - heroku config:set WITH_SERVICES=true
      - heroku config:set NODE_PATH=.
      - heroku config:set FIREBASE_URL="https://timepix-dev.firebaseio.com"
      - heroku config:set DOCURL="https://timepix-dev.herokuapp.com"
      - git config --global user.email "sebastian.ovide@gmail.com"
      - git config --global user.name "sebastian ovide"
      - cd build && git init . && heroku git:remote -a timepix-dev && git add . && git commit -am "make it better" && git push heroku master -f
      - rm -rf build/.git
